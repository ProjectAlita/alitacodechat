name: Continuous Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment:
          - { SERVER_HOST: "https://eye.projectalita.ai", SERVER_PID: "1396", SERVER_TOKEN: "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJ1dWlkIjoiZjZiODUxMjMtODk0YS00OWJlLTg5YzQtNDZmZmFhZDVkMDE4IiwiZXhwaXJlcyI6IjIwMjUtMDctMTBUMTU6MDgifQ.4LFVbtLPacqzcvANGjjXJ-oHe-fxQK-haeq850Bl6FkNZhpgV12MIMuJSuCUwgAKxo_OWIonikTeKJCN46j9Lw" }
          - { SERVER_HOST: "https://eye.projectalita.ai/main", SERVER_PID: "159", SERVER_TOKEN: "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJ1dWlkIjoiNjhlMzI3MjItYWIxNy00NmVmLThmNWYtNmFiYjdhOTg3NDIwIiwiZXhwaXJlcyI6IjIwMjUtMDctMTBUMTU6MDcifQ.e1X78yDbwBDrZXaLUjzV_P1NWf56X8COm2YQpqCJtP5L8rjnPBJoe0yz8MqxQn0DnU80WY7YknJh_W_2nUNy1A" }

    steps:
    - uses: actions/checkout@v4
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Install root dependencies
      run: npm install
    - name: Install UI dependencies
      run: |
        cd packages/ui
        npm install
    - name: Start server
      run: |
        cd packages/ui/test/plugin
        npm install
        node server.js -sh ${{ matrix.environment.SERVER_HOST }} -spid ${{ matrix.environment.SERVER_PID }} -muid 596884aa-fc90-4e19-8de0-8ef90fa5a9b6 -st ${{ matrix.environment.SERVER_TOKEN }} &
    - name: Start chat/webpack run
      run: |
        cd packages/ui
        npx webpack --env plugin=http://localhost:3333 &
    - name: Install test dependencies and run tests
      run: |
        cd packages/ui/test/ui_test
        npm install
        npx playwright install
        npm test
    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failed-test-results
        path: packages/ui/test/ui_test/test-results/
